name: Auto Update Weather Data
on:
  schedule:
    # æ¯å°æ—¶ç¬¬1åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: '1 * * * *'
  workflow_dispatch: # å…è®¸åœ¨GitHubé¡µé¢ä¸Šæ‰‹åŠ¨è§¦å‘è¿è¡Œ
  push:
    branches: [ main ] # å½“mainåˆ†æ”¯æœ‰æ¨é€æ—¶ä¹Ÿè¿è¡Œï¼ˆå¯é€‰ï¼‰

permissions:
  contents: write # å…è®¸å·¥ä½œæµå‘ä»“åº“æäº¤æ–‡ä»¶

jobs:
  update-weather-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. è®¾ç½®Pythonç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml selenium webdriver-manager

      - name: 3. æ‰§è¡Œå¤©æ°”æ•°æ®æŠ“å–è„šæœ¬ï¼ˆä½¿ç”¨Seleniumï¼‰
        run: |
          cat > fetch_weather.py << 'EOF'
          from datetime import datetime, timezone, timedelta
          import csv
          import re
          import json

          def get_beijing_time():
              """è·å–å½“å‰åŒ—äº¬æ—¶é—´ (UTC+8)"""
              utc_now = datetime.now(timezone.utc)
              beijing_tz = timezone(timedelta(hours=8))
              beijing_now = utc_now.astimezone(beijing_tz)
              return beijing_now

          def fetch_weather_data_with_selenium():
              """ä½¿ç”¨SeleniumæŠ“å–å¤©æ°”æ•°æ®"""
              try:
                  from selenium import webdriver
                  from selenium.webdriver.chrome.service import Service
                  from selenium.webdriver.chrome.options import Options
                  from selenium.webdriver.common.by import By
                  from selenium.webdriver.support.ui import WebDriverWait
                  from selenium.webdriver.support import expected_conditions as EC
                  from webdriver_manager.chrome import ChromeDriverManager
                  from bs4 import BeautifulSoup
                  
                  TARGET_URL = "https://tianqi.moji.com/weather/china/sichuan/longquanyi-district"
                  
                  print(f"ğŸŒ¤ï¸ æ­£åœ¨ä½¿ç”¨Seleniumè®¿é—®å¤©æ°”ç½‘ç«™: {TARGET_URL}")
                  
                  # è®¾ç½®Chromeé€‰é¡¹
                  chrome_options = Options()
                  chrome_options.add_argument('--headless')  # æ— å¤´æ¨¡å¼
                  chrome_options.add_argument('--no-sandbox')
                  chrome_options.add_argument('--disable-dev-shm-usage')
                  chrome_options.add_argument('--disable-gpu')
                  chrome_options.add_argument('--window-size=1920,1080')
                  chrome_options.add_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36')
                  
                  # åˆ›å»ºé©±åŠ¨
                  service = Service(ChromeDriverManager().install())
                  driver = webdriver.Chrome(service=service, options=chrome_options)
                  
                  try:
                      driver.get(TARGET_URL)
                      
                      # ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
                      WebDriverWait(driver, 10).until(
                          EC.presence_of_element_located((By.CLASS_NAME, "hours"))
                      )
                      
                      # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©JavaScriptåŠ è½½æ•°æ®
                      import time
                      time.sleep(3)
                      
                      # è·å–é¡µé¢æºä»£ç 
                      page_source = driver.page_source
                      
                      # ä½¿ç”¨BeautifulSoupè§£æ
                      soup = BeautifulSoup(page_source, 'lxml')
                      
                      hourly_forecast = []
                      
                      # æŸ¥æ‰¾24å°æ—¶é¢„æŠ¥åŒºåŸŸ
                      hours_section = soup.find('div', class_='hours')
                      if hours_section:
                          print("âœ… æ‰¾åˆ°24å°æ—¶é¢„æŠ¥åŒºåŸŸ")
                          
                          # æ–¹æ³•1: å°è¯•ä»JavaScriptæ•°æ®ä¸­æå–
                          script_tags = soup.find_all('script')
                          for script in script_tags:
                              if script.string:
                                  # æŸ¥æ‰¾åŒ…å«æ¸©åº¦æ•°æ®çš„JavaScriptå˜é‡
                                  temp_patterns = [
                                      r'chartData.*?=\s*(\[.*?\])',
                                      r'tempData.*?=\s*(\[.*?\])',
                                      r'hoursData.*?=\s*(\[.*?\])',
                                      r'var\s+.*?=\s*(\[.*?\])'
                                  ]
                                  
                                  for pattern in temp_patterns:
                                      matches = re.search(pattern, script.string, re.DOTALL)
                                      if matches:
                                          try:
                                              # å°è¯•è§£æJSONæ•°æ®
                                              json_str = matches.group(1)
                                              # æ¸…ç†JSONå­—ç¬¦ä¸²
                                              json_str = re.sub(r'/\*.*?\*/', '', json_str)  # ç§»é™¤æ³¨é‡Š
                                              json_str = json_str.strip()
                                              
                                              # å°è¯•è§£æ
                                              data = json.loads(json_str)
                                              
                                              if isinstance(data, list) and len(data) > 0:
                                                  # å‡è®¾æ•°æ®æ˜¯æ¸©åº¦æ•°ç»„
                                                  for i, temp in enumerate(data[:24]):
                                                      hour = f"{i:02d}:00"
                                                      hourly_forecast.append({
                                                          'forecast_time': hour,
                                                          'temperature': f"{temp}Â°C"
                                                      })
                                                  print(f"âœ… ä»JavaScriptä¸­æå–äº† {len(hourly_forecast)} å°æ—¶æ•°æ®")
                                                  break
                                          except:
                                              continue
                      
                      # å¦‚æœJavaScriptæ–¹æ³•å¤±è´¥ï¼Œå°è¯•ä»é¡µé¢æ–‡æœ¬ä¸­æå–
                      if not hourly_forecast:
                          print("âš ï¸  ä»JavaScriptæå–æ•°æ®å¤±è´¥ï¼Œå°è¯•æ–‡æœ¬åˆ†æ...")
                          
                          # æŸ¥æ‰¾æ‰€æœ‰æ–‡æœ¬ä¸­çš„æ—¶é—´æ¸©åº¦æ¨¡å¼
                          all_text = soup.get_text()
                          
                          # æŸ¥æ‰¾æ—¶é—´æ¸©åº¦æ¨¡å¼
                          time_temp_patterns = [
                              r'(\d{1,2}):(\d{2})[^\dâ„ƒ]*(-?\d+)[â„ƒÂ°C]',
                              r'(\d{1,2})ç‚¹[^\dâ„ƒ]*(-?\d+)[â„ƒÂ°C]',
                              r'(\d{1,2})æ—¶[^\dâ„ƒ]*(-?\d+)[â„ƒÂ°C]'
                          ]
                          
                          for pattern in time_temp_patterns:
                              matches = re.findall(pattern, all_text)
                              if matches:
                                  for match in matches:
                                      hour = match[0]
                                      minute = match[1] if len(match) > 2 else '00'
                                      temp = match[2] if len(match) > 2 else match[1]
                                      hourly_forecast.append({
                                          'forecast_time': f"{hour}:{minute}",
                                          'temperature': f"{temp}Â°C"
                                      })
                                  if hourly_forecast:
                                      print(f"âœ… ä»æ–‡æœ¬ä¸­æå–äº† {len(hourly_forecast)} å°æ—¶æ•°æ®")
                                      break
                      
                      # å¦‚æœä»ç„¶æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»å›¾è¡¨æ•°æ®ç‚¹ä¸­æå–
                      if not hourly_forecast:
                          print("âš ï¸  æ–‡æœ¬åˆ†æå¤±è´¥ï¼Œå°è¯•ä»å›¾è¡¨æ•°æ®ç‚¹æå–...")
                          
                          # æŸ¥æ‰¾å›¾è¡¨æ•°æ®ç‚¹
                          canvas_points = soup.find_all('div', class_='canvas_point')
                          for point in canvas_points:
                              temp_elem = point.find('em')
                              if temp_elem:
                                  temp_text = temp_elem.get_text(strip=True)
                                  temp_match = re.search(r'(-?\d+)Â°', temp_text)
                                  if temp_match:
                                      # ç”Ÿæˆæ—¶é—´ï¼ˆå‡è®¾æ˜¯é¡ºåºæ’åˆ—ï¼‰
                                      hour = len(hourly_forecast)
                                      hourly_forecast.append({
                                          'forecast_time': f"{hour:02d}:00",
                                          'temperature': f"{temp_match.group(1)}Â°C"
                                      })
                          
                          if hourly_forecast:
                              print(f"âœ… ä»å›¾è¡¨æ•°æ®ç‚¹æå–äº† {len(hourly_forecast)} å°æ—¶æ•°æ®")
                      
                      return hourly_forecast[:24]  # é™åˆ¶æœ€å¤š24æ¡
                      
                  finally:
                      driver.quit()
                      
              except Exception as e:
                  print(f"âŒ SeleniumæŠ“å–å¤±è´¥: {e}")
                  import traceback
                  traceback.print_exc()
                  return None

          def create_fallback_data():
              """åˆ›å»ºå¤‡ç”¨æ•°æ®"""
              print("ğŸ“ åˆ›å»ºå¤‡ç”¨æ•°æ®...")
              hourly_forecast = []
              current_hour = get_beijing_time().hour
              
              # ç”Ÿæˆæœªæ¥24å°æ—¶çš„æ•°æ®
              base_temp = 15  # åŸºç¡€æ¸©åº¦
              
              for i in range(24):
                  hour = (current_hour + i) % 24
                  # æ¨¡æ‹Ÿæ¸©åº¦å˜åŒ–ï¼ˆç™½å¤©é«˜ï¼Œæ™šä¸Šä½ï¼‰
                  if 6 <= hour <= 17:  # ç™½å¤©
                      temperature = base_temp + 3 + (i % 3)
                  else:  # æ™šä¸Šå’Œå‡Œæ™¨
                      temperature = base_temp - 2 + (i % 2)
                  
                  hourly_forecast.append({
                      'forecast_time': f"{hour:02d}:00",
                      'temperature': f"{temperature}Â°C"
                  })
              
              return hourly_forecast

          def save_weather_data(forecast_data, method_used):
              """ä¿å­˜å¤©æ°”æ•°æ®åˆ°CSV"""
              beijing_time = get_beijing_time()
              update_time_str = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
              
              TARGET_URL = "https://tianqi.moji.com/weather/china/sichuan/longquanyi-district"
              
              with open('weather_forecast.csv', 'w', newline='', encoding='utf-8') as f:
                  writer = csv.writer(f)
                  
                  # å†™å…¥è¡¨å¤´
                  writer.writerow(['update_time', 'forecast_time', 'temperature', 'data_source', 'method'])
                  
                  if forecast_data:
                      for forecast in forecast_data:
                          writer.writerow([
                              update_time_str,
                              forecast['forecast_time'],
                              forecast['temperature'],
                              TARGET_URL,
                              method_used
                          ])
                      print(f"âœ… å·²ä¿å­˜ {len(forecast_data)} æ¡æ•°æ®")
                  else:
                      writer.writerow([
                          update_time_str,
                          'N/A',
                          'N/A',
                          TARGET_URL,
                          'no_data'
                      ])
                      print("âš ï¸  æœªè·å–åˆ°æ•°æ®")
              
              return update_time_str, len(forecast_data) if forecast_data else 0

          # ä¸»ç¨‹åº
          if __name__ == "__main__":
              print("=" * 60)
              print("ğŸŒ¤ï¸  å¤©æ°”æ•°æ®æŠ“å–ä»»åŠ¡å¼€å§‹")
              beijing_time = get_beijing_time()
              print(f"ğŸ“… å½“å‰åŒ—äº¬æ—¶é—´: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
              print("=" * 60)
              
              # å°è¯•ä½¿ç”¨SeleniumæŠ“å–çœŸå®æ•°æ®
              forecast_data = fetch_weather_data_with_selenium()
              method_used = "selenium"
              
              # å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®
              if not forecast_data:
                  print("âš ï¸  SeleniumæŠ“å–å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®")
                  forecast_data = create_fallback_data()
                  method_used = "fallback"
              
              # ä¿å­˜æ•°æ®
              update_time, data_count = save_weather_data(forecast_data, method_used)
              
              # æ˜¾ç¤ºç»“æœ
              print("-" * 60)
              print(f"ğŸ“Š è·å–ç»“æœ:")
              print(f"  æ–¹æ³•: {method_used}")
              print(f"  æ•°æ®é‡: {data_count} å°æ—¶")
              print(f"  æ›´æ–°æ—¶é—´: {update_time}")
              
              if forecast_data and data_count > 0:
                  print("\nğŸ“ˆ å‰6å°æ—¶é¢„æŠ¥:")
                  for i, forecast in enumerate(forecast_data[:6]):
                      print(f"  {forecast['forecast_time']}: {forecast['temperature']}")
              
              print("=" * 60)
              print("ğŸ‰ ä»»åŠ¡å®Œæˆ!")
              print("=" * 60)
          EOF
          
          echo "å¼€å§‹æ‰§è¡ŒPythonè„šæœ¬..."
          python3 fetch_weather.py

      - name: 4. æŸ¥çœ‹ç”Ÿæˆçš„CSVæ–‡ä»¶
        run: |
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la *.csv 2>/dev/null || echo "æœªæ‰¾åˆ°CSVæ–‡ä»¶"
          echo ""
          echo "=== CSVæ–‡ä»¶å†…å®¹é¢„è§ˆ ==="
          if [ -f "weather_forecast.csv" ]; then
            echo "æ•°æ®é¢„è§ˆ:"
            head -10 weather_forecast.csv
            echo ""
            echo "æ•°æ®ç»Ÿè®¡:"
            echo "æ€»è¡Œæ•°: $(wc -l < weather_forecast.csv)"
            echo "æœ€æ–°æ›´æ–°æ—¶é—´: $(head -2 weather_forecast.csv | tail -1 | cut -d',' -f1)"
            echo "ä½¿ç”¨çš„æ–¹æ³•: $(head -2 weather_forecast.csv | tail -1 | cut -d',' -f5)"
          fi

      - name: 5. æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ CSVæ–‡ä»¶
          git add weather_forecast.csv 2>/dev/null || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            METHOD=$(tail -1 weather_forecast.csv 2>/dev/null | cut -d',' -f5 || echo "unknown")
            COUNT=$(( $(wc -l < weather_forecast.csv 2>/dev/null || echo 1) - 1 ))
            git commit -m "ğŸŒ¤ï¸ æ›´æ–°å¤©æ°”æ•°æ® [${BEIJING_TIME}] - ${COUNT}å°æ—¶é¢„æŠ¥ (${METHOD})"
            git push
            echo "âœ… æ•°æ®å·²æäº¤"
          fi
