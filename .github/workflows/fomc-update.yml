name: Auto Update FOMC Calendar
on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/fomc-update.yml' 
  schedule:
    # 每周一中午12点（UTC时间）运行一次，对应北京时间周一晚8点
    - cron: '0 12 * * 1'
  workflow_dispatch: # 允许在GitHub页面上手动触发运行

permissions:
  contents: write # 允许工作流向仓库提交文件

jobs:
  update-fomc-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. 设置Python环境并安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml jq

      - name: 3. 执行FOMC数据抓取脚本（北京时间时区）
        run: |
          cat > fetch_fomc.py << 'EOF'
          # [Python脚本内容保持不变]
          EOF
          
          echo "开始执行Python脚本..."
          python3 fetch_fomc.py

      - name: 4. 查看生成的文件
        run: |
          echo "=== 生成的文件列表 ==="
          ls -la *.json *.csv *.txt 2>/dev/null || echo "未找到数据文件"
          echo ""
          echo "=== JSON文件元信息预览 ==="
          if [ -f "fomc_calendar.json" ]; then
            python3 -c "
import json, sys
try:
    with open('fomc_calendar.json', 'r') as f:
        data = json.load(f)
    print('最后更新时间:', data.get('meta', {}).get('last_updated', 'N/A'))
    print('会议数量:', data.get('meta', {}).get('count', 0))
except Exception as e:
    print('无法解析JSON:', e)
" || head -15 fomc_calendar.json
          else
            echo "fomc_calendar.json 文件不存在"
          fi
          echo ""
          echo "=== 前5个会议预览 ==="
          if [ -f "fomc_calendar.json" ]; then
            python3 -c "
import json, sys
try:
    with open('fomc_calendar.json', 'r') as f:
        data = json.load(f)
    meetings = data.get('meetings', [])[:5]
    for i, m in enumerate(meetings):
        print(f'{i+1}. {m.get(\"start_date\", \"N/A\")} 至 {m.get(\"end_date\", \"N/A\")}')
except Exception as e:
    print('无法解析JSON:', e)
" 2>/dev/null || echo "无法解析JSON"
          fi

      - name: 5. 提交更新到仓库
        run: |
          # 配置Git用户
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加生成的数据文件
          git add fomc_calendar.json fomc_calendar.csv fomc_dates.txt 2>/dev/null || echo "注意：未找到数据文件"
          
          # 检查是否有文件变更
          if git diff --staged --quiet; then
            echo "ℹ️  数据无变化，无需提交。"
          else
            # 提交并推送（使用北京时间时间戳）
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            git commit -m "🤖 自动更新FOMC日历数据 [${BEIJING_TIME} 北京时间] - 仅当前及未来年份"
            git push
            echo "✅ 数据更新已提交并推送！"
          fi
