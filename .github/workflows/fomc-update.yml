name: Auto Update FOMC Calendar
on:
  schedule:
    # æ¯å‘¨ä¸€ä¸­åˆ12ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰è¿è¡Œä¸€æ¬¡ï¼ŒåŒ—äº¬æ—¶é—´æ™š8ç‚¹
    - cron: '0 12 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-fomc-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…PythonåŠä¾èµ–
        run: pip3 install requests beautifulsoup4

      - name: 3. æ‰§è¡Œç²¾å‡†æŠ“å–è„šæœ¬
        run: |
          cat > fetch_fomc.py << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime
          import json, csv
          import re

          TARGET_URL = "https://www.federalreserve.gov/monetarypolicy/fomccalendars.htm"
          HEADERS = {'User-Agent': 'Mozilla/5.0'}

          def parse_month_year(month_str, year):
              """å°†'January'æˆ–'Jan/Feb'è½¬æ¢ä¸ºæœˆä»½æ•°å­—"""
              month_map = {
                  'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4, 'may': 5, 'jun': 6,
                  'jul': 7, 'aug': 8, 'sep': 9, 'oct': 10, 'nov': 11, 'dec': 12
              }
              # å¤„ç†ç±»ä¼¼ "Apr/May" çš„æƒ…å†µï¼Œå–ç¬¬ä¸€ä¸ªæœˆ
              clean_month = month_str.split('/')[0].strip().lower()[:3]
              return month_map.get(clean_month, 1)

          def parse_date_range(date_str, month, year):
              """è§£æž'27-28'æˆ–'1-2'è¿™æ ·çš„æ—¥æœŸèŒƒå›´ï¼Œè¿”å›žå¼€å§‹å’Œç»“æŸæ—¥æœŸ"""
              # ç§»é™¤æ˜Ÿå·å’Œç©ºæ ¼
              clean_date = date_str.replace('*', '').strip()
              if '-' not in clean_date:
                  # å•æ—¥ä¼šè®®ï¼Œç†è®ºä¸Šå®˜ç½‘æ²¡æœ‰ï¼Œä½†åšä¸ªå®¹é”™
                  day = int(clean_date)
                  return f"{year}-{month:02d}-{day:02d}", f"{year}-{month:02d}-{day:02d}"
              
              start_day, end_day = map(int, clean_date.split('-'))
              # å¤„ç†è·¨æœˆï¼Œä¾‹å¦‚4æœˆ30æ—¥-5æœˆ1æ—¥
              end_month = month
              end_year = year
              if end_day < start_day: # å¦‚æžœç»“æŸæ—¥å°äºŽå¼€å§‹æ—¥ï¼Œè¯´æ˜Žè·¨æœˆäº†
                  end_month = month + 1 if month < 12 else 1
                  if end_month == 1: # å¦‚æžœè·¨å¹´åˆ°1æœˆ
                      end_year = year + 1
              
              start_date = f"{year}-{month:02d}-{start_day:02d}"
              end_date = f"{end_year}-{end_month:02d}-{end_day:02d}"
              return start_date, end_date

          print(f"æ­£åœ¨æŠ“å–: {TARGET_URL}")
          resp = requests.get(TARGET_URL, headers=HEADERS, timeout=30)
          resp.raise_for_status()
          soup = BeautifulSoup(resp.content, 'html.parser')
          
          all_meetings = []
          # æ‰¾åˆ°æ‰€æœ‰å¹´ä»½çš„é¢æ¿
          year_panels = soup.find_all('div', class_='panel panel-default')
          print(f"æ‰¾åˆ° {len(year_panels)} ä¸ªå¹´ä»½é¢æ¿")
          
          for panel in year_panels:
              # ä»Žé¢æ¿æ ‡é¢˜ä¸­æå–å¹´ä»½
              year_heading = panel.find('div', class_='panel-heading')
              if not year_heading:
                  continue
                  
              year_match = re.search(r'\b(20\d\d)\b', year_heading.get_text())
              if not year_match:
                  continue
                  
              current_year = int(year_match.group(1))
              print(f"  å¤„ç† {current_year} å¹´...")
              
              # æ‰¾åˆ°è¯¥å¹´ä»½ä¸‹çš„æ‰€æœ‰ä¼šè®®è¡Œ
              meeting_rows = panel.find_all('div', class_='fomc-meeting')
              if not meeting_rows:
                  meeting_rows = panel.find_all('div', class_='fomc-meeting--shaded row fomc-meeting')
              
              for row in meeting_rows:
                  # æå–æœˆä»½
                  month_elem = row.find('div', class_='fomc-meeting__month')
                  # æå–æ—¥æœŸ
                  date_elem = row.find('div', class_='fomc-meeting__date')
                  
                  if not (month_elem and date_elem):
                      continue
                      
                  month_text = month_elem.get_text(strip=True)
                  date_text = date_elem.get_text(strip=True)
                  
                  # åˆ¤æ–­æ˜¯å¦ä¸ºSEPä¼šè®®ï¼ˆå¸¦æ˜Ÿå·*çš„ä¼šè®®ï¼‰
                  is_sep = '*' in date_text
                  has_press = is_sep  # æ ¹æ®å®˜ç½‘è§„åˆ™ï¼ŒSEPä¼šè®®éƒ½æœ‰æ–°é—»å‘å¸ƒä¼š
                  
                  # è§£æžæ—¥æœŸ
                  month_num = parse_month_year(month_text, current_year)
                  start_date, end_date = parse_date_range(date_text, month_num, current_year)
                  
                  meeting_info = {
                      'year': current_year,
                      'start_date': start_date,
                      'end_date': end_date,
                      'month_display': month_text,
                      'date_display': date_text.replace('*', '').strip(),
                      'is_sep': is_sep,
                      'has_press': has_press,
                      'summary': 'FOMC Meeting' + ('*' if is_sep else '')
                  }
                  all_meetings.append(meeting_info)
          
          # æŒ‰å¼€å§‹æ—¥æœŸæŽ’åº
          all_meetings.sort(key=lambda x: x['start_date'])
          print(f"æ€»è®¡æŠ“å–åˆ° {len(all_meetings)} ä¸ªFOMCä¼šè®®")
          return all_meetings

          if __name__ == "__main__":
              meetings = fetch_fomc_meetings()
              
              # ä¿å­˜ä¸ºJSON
              with open('fomc_calendar.json', 'w', encoding='utf-8') as f:
                  json.dump({
                      'meta': {
                          'last_updated': datetime.now().isoformat(),
                          'source': TARGET_URL,
                          'count': len(meetings)
                      },
                      'meetings': meetings
                  }, f, indent=2, ensure_ascii=False)
              
              # ä¿å­˜ä¸ºCSV
              if meetings:
                  with open('fomc_calendar.csv', 'w', encoding='utf-8', newline='') as f:
                      writer = csv.DictWriter(f, fieldnames=['year', 'start_date', 'end_date', 'summary', 'is_sep', 'has_press'])
                      writer.writeheader()
                      for m in meetings:
                          writer.writerow({
                              'year': m['year'],
                              'start_date': m['start_date'],
                              'end_date': m['end_date'],
                              'summary': m['summary'],
                              'is_sep': m['is_sep'],
                              'has_press': m['has_press']
                          })
              
              # ä¿å­˜ä¸ºçº¯æ–‡æœ¬
              with open('fomc_dates.txt', 'w', encoding='utf-8') as f:
                  for m in meetings:
                      f.write(f"{m['start_date']} to {m['end_date']}: {m['summary']}\n")
              
              print("æ•°æ®å·²æˆåŠŸä¿å­˜åˆ° fomc_calendar.json, fomc_calendar.csv, fomc_dates.txt")
          EOF
          
          python3 fetch_fomc.py

      - name: 4. æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add fomc_calendar.json fomc_calendar.csv fomc_dates.txt
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°FOMCæ—¥åŽ†æ•°æ® [$(date +%Y-%m-%d)]"
            git push
            echo "âœ… æ•°æ®æ›´æ–°å·²æäº¤å¹¶æŽ¨é€ï¼"
          else
            echo "â„¹ï¸  æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          fi
