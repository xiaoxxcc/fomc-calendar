# FOMC会议日期自动同步：适配美联储官网最新HTML+解决403权限
name: Auto Update FOMC Calendar
on:
  schedule:
    - cron: '0 0 * * 0'  # 每周日UTC 0点自动更新（北京时间早8点）
  workflow_dispatch:      # 支持手动触发更新
  push:
    branches: [main, master]
# 新增：授予Actions仓库写入权限，解决403 Permission denied
permissions:
  contents: write
jobs:
  update-fomc-data:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装依赖（HTML解析+请求+日期处理）
        run: |
          sudo apt update && sudo apt install -y curl jq python3-pip
          pip3 install requests beautifulsoup4 lxml python-dateutil

      - name: 编写Python解析脚本（适配美联储官网最新结构）
        run: |
          cat > parse_fomc.py << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime, date
          import json
          import csv
          from dateutil import parser
          import os

          # 美联储官方日历网页（最新有效）
          FOMC_URL = "https://www.federalreserve.gov/monetarypolicy/fomccalendars.htm"
          # 模拟浏览器请求头，避免被屏蔽
          HEADERS = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36",
              "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
              "Accept-Language": "en-US,en;q=0.5",
              "Cache-Control": "no-cache"
          }
          TIMEOUT = 30
          # 输出文件（仓库根目录）
          TXT_FILE = "fomc_dates.txt"
          CSV_FILE = "fomc_calendar.csv"
          JSON_FILE = "fomc_calendar.json"

          def get_fomc_meetings():
              """核心：适配官网最新结构，抓取未来FOMC会议数据"""
              try:
                  # 发送请求
                  res = requests.get(FOMC_URL, headers=HEADERS, timeout=TIMEOUT)
                  res.raise_for_status()
                  soup = BeautifulSoup(res.text, "lxml")
                  meetings = []
                  today = date.today()
                  # 适配官网最新：会议项在div.fomc-meeting-wrapper下的div.fomc-meeting
                  meeting_wrappers = soup.find_all("div", class_="fomc-meeting-wrapper")
                  if not meeting_wrappers:
                      # 兜底匹配：直接找所有含fomc-meeting的div
                      meeting_wrappers = soup.find_all("div", class_=lambda c: c and "fomc-meeting" in c)

                  for wrapper in meeting_wrappers:
                      # 提取会议日期（官网最新节点：h3.fomc-meeting__date）
                      date_tag = wrapper.find("h3", class_="fomc-meeting__date") or wrapper.find("div", class_="date")
                      if not date_tag:
                          continue
                      date_text = date_tag.get_text(strip=True).replace("\n", "").replace("\t", "")
                      # 过滤无效日期，只保留含2025-2028的（未来会议）
                      if not any(str(y) in date_text for y in [2025, 2026, 2027, 2028]):
                          continue

                      # 解析开始/结束日期（处理Mar 17-18, 2026 / Jan 28, 2026两种格式）
                      start_dt, end_dt = None, None
                      try:
                          if "-" in date_text:
                              # 跨天会议：拆分开始和结束
                              part1, part2 = date_text.split("-", 1)
                              year = part2.split(",")[-1].strip()
                              start_str = f"{part1.strip()}, {year}"
                              end_day = part2.split(",")[0].strip()
                              end_str = f"{part1.split()[0]} {end_day}, {year}"
                              start_dt = parser.parse(start_str).date()
                              end_dt = parser.parse(end_str).date()
                          else:
                              # 单日会议
                              start_dt = parser.parse(date_text).date()
                              end_dt = start_dt
                      except:
                          continue

                      # 过滤历史会议
                      if start_dt < today:
                          continue

                      # 判断是否为SEP会议（官网SEP会议标*，或含Summary of Economic Projections）
                      sep_tag = wrapper.find("p", class_="fomc-meeting__desc") or wrapper.find("div", class_="desc")
                      sep_text = sep_tag.get_text(strip=True) if sep_tag else ""
                      is_sep = "*" in date_text or "*" in sep_text or "SEP" in sep_text.upper() or "Summary of Economic Projections" in sep_text
                      # SEP会议必带新闻发布会，非SEP无（美联储规则）
                      has_press = is_sep
                      # 统一会议摘要
                      summary = f"FOMC Meeting{'*' if is_sep else ''}"

                      # 结构化数据
                      meetings.append({
                          "start_date": start_dt.strftime("%Y-%m-%d"),
                          "end_date": end_dt.strftime("%Y-%m-%d"),
                          "summary": summary,
                          "is_sep": is_sep,
                          "has_press": has_press
                      })

                  # 去重+按日期升序排序
                  meetings = list({m["start_date"]: m for m in meetings}.values())
                  meetings.sort(key=lambda x: x["start_date"])
                  return meetings

              except Exception as e:
                  print(f"抓取/解析失败：{str(e)}")
                  return []

          def save_files(meetings):
              """保存为txt/CSV/JSON，仓库根目录"""
              if not meetings:
                  print("警告：未抓取到未来FOMC会议数据")
                  return
              # 保存txt：仅开始日期，每行一个
              with open(TXT_FILE, "w", encoding="utf-8") as f:
                  f.write("\n".join([m["start_date"] for m in meetings]))
              # 保存CSV
              with open(CSV_FILE, "w", encoding="utf-8", newline="") as f:
                  fieldnames = ["start_date", "end_date", "summary", "is_sep", "has_press"]
                  writer = csv.DictWriter(f, fieldnames=fieldnames)
                  writer.writeheader()
                  writer.writerows(meetings)
              # 保存JSON
              with open(JSON_FILE, "w", encoding="utf-8") as f:
                  json.dump(meetings, f, ensure_ascii=False, indent=2)
              print(f"成功生成文件！共抓取{len(meetings)}条未来FOMC会议数据")
              # 打印文件路径，确认在根目录
              print(f"文件路径：{os.path.abspath(TXT_FILE)}")

          if __name__ == "__main__":
              fomc_data = get_fomc_meetings()
              save_files(fomc_data)
          EOF
          # 运行解析脚本，生成文件
          python3 parse_fomc.py

      - name: 提交并推送文件到仓库
        run: |
          # 配置Git用户
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # 添加生成的文件
          git add fomc_dates.txt fomc_calendar.csv fomc_calendar.json || echo "暂未生成文件，跳过添加"
          # 提交（无变化则跳过）
          git commit -m "Auto update FOMC calendar $(date +'%Y-%m-%d %H:%M:%S UTC')" || echo "无数据变化，无需提交"
          # 推送（解决403的核心：permissions已开write）
          git push origin $GITHUB_REF_NAME || echo "推送失败（无变化）"
