name: Auto Update FOMC Calendar
on:
  schedule:
    # æ¯å‘¨ä¸€ä¸­åˆ12ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰è¿è¡Œä¸€æ¬¡ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´å‘¨ä¸€æ™š8ç‚¹
    - cron: '0 12 * * 1'
  workflow_dispatch: # å…è®¸åœ¨GitHubé¡µé¢ä¸Šæ‰‹åŠ¨è§¦å‘è¿è¡Œ
  push:
    branches: [ main ] # å½“mainåˆ†æ”¯æœ‰æ¨é€æ—¶ä¹Ÿè¿è¡Œï¼ˆå¯é€‰ï¼‰

permissions:
  contents: write # å…è®¸å·¥ä½œæµå‘ä»“åº“æäº¤æ–‡ä»¶

jobs:
  update-fomc-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. è®¾ç½®Pythonç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: 3. æ‰§è¡ŒFOMCæ•°æ®æŠ“å–è„šæœ¬ï¼ˆåŒ—äº¬æ—¶é—´æ—¶åŒºï¼‰
        run: |
          cat > fetch_fomc.py << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime, timezone, timedelta
          import json
          import csv
          import re

          # é…ç½®
          TARGET_URL = "https://www.federalreserve.gov/monetarypolicy/fomccalendars.htm"
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.5',
              'Cache-Control': 'no-cache'
          }

          def get_beijing_time():
              """è·å–å½“å‰åŒ—äº¬æ—¶é—´ (UTC+8)"""
              utc_now = datetime.now(timezone.utc)
              beijing_tz = timezone(timedelta(hours=8))
              beijing_now = utc_now.astimezone(beijing_tz)
              return beijing_now

          def parse_month_text(month_str):
              """å°†æœˆä»½æ–‡æœ¬è½¬æ¢ä¸ºæ•°å­— (1-12)"""
              month_map = {
                  'jan': 1, 'january': 1,
                  'feb': 2, 'february': 2,
                  'mar': 3, 'march': 3,
                  'apr': 4, 'april': 4,
                  'may': 5,
                  'jun': 6, 'june': 6,
                  'jul': 7, 'july': 7,
                  'aug': 8, 'august': 8,
                  'sep': 9, 'september': 9,
                  'oct': 10, 'october': 10,
                  'nov': 11, 'november': 11,
                  'dec': 12, 'december': 12
              }
              # å¤„ç†ç±»ä¼¼ "Apr/May" çš„æƒ…å†µï¼Œå–ç¬¬ä¸€ä¸ªæœˆ
              clean_month = month_str.lower().split('/')[0].strip()
              short_month = clean_month[:3]
              return month_map.get(clean_month) or month_map.get(short_month)

          def parse_date_range(date_str, month, year):
              """è§£ææ—¥æœŸèŒƒå›´å­—ç¬¦ä¸²ï¼Œå¦‚ "27-28", "30-1" """
              clean_date = re.sub(r'[^\d\-]', '', date_str)
              
              if '-' not in clean_date:
                  day = int(clean_date)
                  start_date = f"{year:04d}-{month:02d}-{day:02d}"
                  return start_date, start_date
              
              parts = clean_date.split('-')
              if len(parts) != 2:
                  raise ValueError(f"æ— æ•ˆçš„æ—¥æœŸæ ¼å¼: {date_str}")
              
              start_day, end_day = map(int, parts)
              
              end_month = month
              end_year = year
              
              if end_day < start_day:
                  end_month = month + 1
                  if end_month > 12:
                      end_month = 1
                      end_year = year + 1
              
              start_date = f"{year:04d}-{month:02d}-{start_day:02d}"
              end_date = f"{end_year:04d}-{end_month:02d}-{end_day:02d}"
              
              return start_date, end_date

          def fetch_and_parse_fomc_meetings():
              """ä¸»å‡½æ•°ï¼šä»ç¾è”å‚¨å®˜ç½‘æŠ“å–å¹¶è§£æFOMCä¼šè®®æ•°æ®"""
              print(f"ğŸ“¡ æ­£åœ¨è®¿é—®ç¾è”å‚¨å®˜ç½‘: {TARGET_URL}")
              try:
                  resp = requests.get(TARGET_URL, headers=HEADERS, timeout=30)
                  resp.raise_for_status()
              except Exception as e:
                  print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
                  return []

              soup = BeautifulSoup(resp.content, 'lxml')
              all_meetings = []
              current_year = datetime.now().year
              
              # æ‰¾åˆ°æ‰€æœ‰å¹´ä»½é¢æ¿
              year_panels = soup.find_all('div', class_='panel panel-default')
              print(f"ğŸ” æ‰¾åˆ° {len(year_panels)} ä¸ªå¹´ä»½é¢æ¿")
              
              for panel in year_panels:
                  # ä»é¢æ¿æ ‡é¢˜æå–å¹´ä»½
                  year_heading = panel.find('div', class_='panel-heading')
                  if not year_heading:
                      continue
                      
                  year_match = re.search(r'\b(20\d\d)\b', year_heading.get_text())
                  if not year_match:
                      continue
                      
                  panel_year = int(year_match.group(1))
                  
                  # åªå¤„ç†å½“å‰å¹´ä»½åŠæœªæ¥çš„å¹´ä»½
                  if panel_year < current_year:
                      print(f"  â© è·³è¿‡ {panel_year} å¹´ï¼ˆå†å²æ•°æ®ï¼Œä¸éœ€è¦ï¼‰")
                      continue
                      
                  print(f"  âœ… å¤„ç† {panel_year} å¹´...")
                  
                  # æ‰¾åˆ°è¯¥å¹´ä»½ä¸‹çš„æ‰€æœ‰ä¼šè®®è¡Œ
                  meeting_rows = panel.find_all('div', class_='row fomc-meeting')
                  shaded_rows = panel.find_all('div', class_='fomc-meeting--shaded row fomc-meeting')
                  meeting_rows.extend(shaded_rows)
                  
                  if not meeting_rows:
                      print(f"    è­¦å‘Š: åœ¨ {panel_year} å¹´é¢æ¿ä¸­æœªæ‰¾åˆ°ä¼šè®®æ•°æ®")
                      continue
                  
                  meeting_count = 0
                  for row in meeting_rows:
                      # æå–æœˆä»½å’Œæ—¥æœŸ
                      month_elem = row.find('div', class_='fomc-meeting__month')
                      date_elem = row.find('div', class_='fomc-meeting__date')
                      
                      if not (month_elem and date_elem):
                          continue
                          
                      month_text = month_elem.get_text(strip=True)
                      date_text = date_elem.get_text(strip=True)
                      
                      if not month_text or not date_text:
                          continue
                      
                      # å¤„ç†æœˆä»½æ–‡æœ¬
                      month_num = parse_month_text(month_text)
                      if month_num is None:
                          print(f"    æ— æ³•è§£ææœˆä»½: {month_text}")
                          continue
                      
                      # åˆ¤æ–­æ˜¯å¦ä¸ºSEPä¼šè®®ï¼ˆå¸¦æ˜Ÿå·*ï¼‰
                      is_sep = '*' in date_text
                      has_press = is_sep
                      
                      # è§£ææ—¥æœŸèŒƒå›´
                      clean_date = date_text.replace('*', '').strip()
                      try:
                          start_date, end_date = parse_date_range(clean_date, month_num, panel_year)
                      except (ValueError, TypeError) as e:
                          print(f"    æ—¥æœŸè§£æé”™è¯¯ '{date_text}': {e}")
                          continue
                      
                      # æ„å»ºä¼šè®®ä¿¡æ¯
                      meeting_info = {
                          'year': panel_year,
                          'start_date': start_date,
                          'end_date': end_date,
                          'month_display': month_text,
                          'date_display': clean_date,
                          'is_sep': is_sep,
                          'has_press': has_press,
                          'summary': f"FOMC Meeting{' *SEP' if is_sep else ''}"
                      }
                      all_meetings.append(meeting_info)
                      meeting_count += 1
                  
                  print(f"    åœ¨ {panel_year} å¹´æ‰¾åˆ° {meeting_count} ä¸ªä¼šè®®")
              
              # æŒ‰å¼€å§‹æ—¥æœŸæ’åº
              all_meetings.sort(key=lambda x: x['start_date'])
              print(f"âœ… æ€»è®¡æŠ“å–åˆ° {len(all_meetings)} ä¸ªFOMCä¼šè®®ï¼ˆå½“å‰å¹´åŠæœªæ¥ï¼‰")
              return all_meetings

          def save_data(meetings):
              """å°†ä¼šè®®æ•°æ®ä¿å­˜ä¸ºJSONã€CSVå’ŒTXTæ–‡ä»¶"""
              if not meetings:
                  print("âš ï¸  æœªè·å–åˆ°æ•°æ®ï¼Œå°†åˆ›å»ºç©ºæ–‡ä»¶")
                  meetings = []
              
              # è·å–åŒ—äº¬æ—¶é—´
              beijing_time = get_beijing_time()
              
              # 1. ä¿å­˜ä¸ºJSON
              json_data = {
                  'meta': {
                      'last_updated': beijing_time.isoformat(),  # ä½¿ç”¨åŒ—äº¬æ—¶é—´
                      'source': TARGET_URL,
                      'count': len(meetings),
                      'note': 'FOMC Meeting Calendar Data (å½“å‰å¹´åŠæœªæ¥)',
                      'current_year': datetime.now().year,
                      'timezone': 'UTC+8 (Beijing Time)'
                  },
                  'meetings': meetings
              }
              
              with open('fomc_calendar.json', 'w', encoding='utf-8') as f:
                  json.dump(json_data, f, indent=2, ensure_ascii=False)
              
              # 2. ä¿å­˜ä¸ºCSV
              if meetings:
                  with open('fomc_calendar.csv', 'w', encoding='utf-8', newline='') as f:
                      fieldnames = ['year', 'start_date', 'end_date', 'summary', 'is_sep', 'has_press']
                      writer = csv.DictWriter(f, fieldnames=fieldnames)
                      writer.writeheader()
                      for m in meetings:
                          writer.writerow({
                              'year': m['year'],
                              'start_date': m['start_date'],
                              'end_date': m['end_date'],
                              'summary': m['summary'],
                              'is_sep': m['is_sep'],
                              'has_press': m['has_press']
                          })
              else:
                  with open('fomc_calendar.csv', 'w', encoding='utf-8', newline='') as f:
                      f.write('year,start_date,end_date,summary,is_sep,has_press\n')
              
              # 3. ä¿å­˜ä¸ºçº¯æ–‡æœ¬
              with open('fomc_dates.txt', 'w', encoding='utf-8') as f:
                  if meetings:
                      for m in meetings:
                          sep_marker = ' *SEP' if m['is_sep'] else ''
                          f.write(f"{m['start_date']} è‡³ {m['end_date']}{sep_marker}\n")
                  else:
                      f.write("æœªæ‰¾åˆ°ä¼šè®®æ•°æ®\n")
              
              print(f"ğŸ’¾ æ•°æ®æ–‡ä»¶å·²ä¿å­˜:")
              print(f"   - fomc_calendar.json ({len(meetings)} ä¸ªä¼šè®®)")
              print(f"   - fomc_calendar.csv")
              print(f"   - fomc_dates.txt")
              
              # æ˜¾ç¤ºåŒ—äº¬æ—¶é—´
              beijing_str = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
              print(f"â° æ•°æ®æ›´æ–°æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: {beijing_str}")

          # ä¸»ç¨‹åºå…¥å£
          if __name__ == "__main__":
              print("=" * 60)
              print("ğŸš€ FOMCæ—¥å†æ•°æ®è‡ªåŠ¨æŠ“å–ä»»åŠ¡å¼€å§‹")
              beijing_time = get_beijing_time()
              print(f"ğŸ“… å½“å‰åŒ—äº¬æ—¶é—´: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
              print("ğŸ“‹ åªè·å–å½“å‰å¹´åŠæœªæ¥çš„ä¼šè®®æ•°æ®")
              print("=" * 60)
              
              meetings_data = fetch_and_parse_fomc_meetings()
              save_data(meetings_data)
              
              print("-" * 60)
              
              # æ˜¾ç¤ºæ‰€æœ‰è·å–çš„ä¼šè®®
              if meetings_data:
                  print("ğŸ“… æ‰€æœ‰è·å–çš„ä¼šè®®:")
                  for i, meeting in enumerate(meetings_data, 1):
                      sep_info = " (SEPä¼šè®®)" if meeting['is_sep'] else ""
                      print(f"  {i:2d}. {meeting['start_date']} è‡³ {meeting['end_date']}{sep_info}")
              
              print("=" * 60)
              print("ğŸ‰ ä»»åŠ¡å®Œæˆï¼")
              print("=" * 60)
          EOF
          
          echo "å¼€å§‹æ‰§è¡ŒPythonè„šæœ¬..."
          python3 fetch_fomc.py

      - name: 4. æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la *.json *.csv *.txt 2>/dev/null || echo "æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶"
          echo ""
          echo "=== JSONæ–‡ä»¶å…ƒä¿¡æ¯é¢„è§ˆ ==="
          if [ -f "fomc_calendar.json" ]; then
            jq '.meta' fomc_calendar.json 2>/dev/null || head -15 fomc_calendar.json
            echo ""
            echo "ä¼šè®®æ•°é‡:"
            jq '.meetings | length' fomc_calendar.json 2>/dev/null || echo "æ— æ³•è·å–æ•°é‡"
          else
            echo "fomc_calendar.json æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          echo ""
          echo "=== å‰5ä¸ªä¼šè®®é¢„è§ˆ ==="
          if [ -f "fomc_calendar.json" ]; then
            jq '.meetings[0:5]' fomc_calendar.json 2>/dev/null || echo "æ— æ³•è§£æJSON"
          fi

      - name: 5. æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶
          git add fomc_calendar.json fomc_calendar.csv fomc_dates.txt 2>/dev/null || echo "æ³¨æ„ï¼šæœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            # æäº¤å¹¶æ¨é€ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´æ—¶é—´æˆ³ï¼‰
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°FOMCæ—¥å†æ•°æ® [${BEIJING_TIME} åŒ—äº¬æ—¶é—´] - ä»…å½“å‰åŠæœªæ¥å¹´ä»½"
            git push
            echo "âœ… æ•°æ®æ›´æ–°å·²æäº¤å¹¶æ¨é€ï¼"
          fi
