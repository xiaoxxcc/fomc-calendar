name: Auto Update Weather Data
on:
  schedule:
    # æ¯å°æ—¶ç¬¬1åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: '1 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-weather-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½®Pythonç¯å¢ƒ
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: 3. æ‰§è¡Œç®€åŒ–ç‰ˆå¤©æ°”æ•°æ®æŠ“å–
        run: |
          cat > fetch_weather_simple.py << 'EOF'
          import requests
          import csv
          import re
          from datetime import datetime, timezone, timedelta
          
          def get_beijing_time():
              utc_now = datetime.now(timezone.utc)
              beijing_tz = timezone(timedelta(hours=8))
              return utc_now.astimezone(beijing_tz)
          
          def fetch_weather_data():
              """ç›´æ¥è®¿é—®å¤©æ°”é¡µé¢ï¼Œå°è¯•è§£ææ•°æ®"""
              url = "https://tianqi.moji.com/weather/china/sichuan/longquanyi-district"
              headers = {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
              }
              
              print(f"æ­£åœ¨è®¿é—®: {url}")
              
              try:
                  response = requests.get(url, headers=headers, timeout=30)
                  response.encoding = 'utf-8'
                  html_content = response.text
                  
                  print(f"è¯·æ±‚æˆåŠŸï¼ŒHTMLé•¿åº¦: {len(html_content)} å­—ç¬¦")
                  
                  # ä¿å­˜HTMLç”¨äºè°ƒè¯•
                  with open('weather_page.html', 'w', encoding='utf-8') as f:
                      f.write(html_content[:10000])  # åªä¿å­˜å‰10000å­—ç¬¦
                  
                  # å°è¯•æŸ¥æ‰¾æ¸©åº¦æ•°æ®
                  # æŸ¥æ‰¾å½“å‰æ¸©åº¦
                  current_temp_match = re.search(r'<em>(\d+)</em>', html_content)
                  current_temp = current_temp_match.group(1) if current_temp_match else "N/A"
                  
                  print(f"å½“å‰æ¸©åº¦: {current_temp}Â°C")
                  
                  # æŸ¥æ‰¾24å°æ—¶é¢„æŠ¥æ•°æ® - å°è¯•æŸ¥æ‰¾JavaScriptæ•°æ®
                  hourly_data = []
                  
                  # æŸ¥æ‰¾JavaScriptä¸­çš„æ¸©åº¦æ•°æ®
                  js_patterns = [
                      r'tempData\s*=\s*\[(.*?)\]',
                      r'temperature.*?\[(.*?)\]',
                      r'hourly.*?\[(.*?)\]'
                  ]
                  
                  for pattern in js_patterns:
                      match = re.search(pattern, html_content, re.DOTALL)
                      if match:
                          print(f"æ‰¾åˆ°JavaScriptæ•°æ®æ¨¡å¼: {pattern[:30]}...")
                          # å°è¯•æå–æ•°å­—
                          numbers = re.findall(r'\d+', match.group(1))
                          if numbers:
                              for i, num in enumerate(numbers[:24]):
                                  hour = f"{i:02d}:00"
                                  hourly_data.append({
                                      'forecast_time': hour,
                                      'temperature': f"{num}Â°C"
                                  })
                              break
                  
                  # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»æ–‡æœ¬ä¸­æå–
                  if not hourly_data:
                      # æŸ¥æ‰¾æ‰€æœ‰æ¸©åº¦æ•°æ®
                      temp_matches = re.findall(r'>(\d+)<', html_content)
                      unique_temps = []
                      for temp in temp_matches:
                          if 0 <= int(temp) <= 40:  # åˆç†çš„æ¸©åº¦èŒƒå›´
                              if temp not in unique_temps:
                                  unique_temps.append(temp)
                      
                      for i, temp in enumerate(unique_temps[:24]):
                          hour = f"{i:02d}:00"
                          hourly_data.append({
                              'forecast_time': hour,
                              'temperature': f"{temp}Â°C"
                          })
                  
                  return hourly_data
                  
              except Exception as e:
                  print(f"æŠ“å–å¤±è´¥: {e}")
                  return None
          
          def create_sample_data():
              """åˆ›å»ºç¤ºä¾‹æ•°æ®"""
              print("åˆ›å»ºç¤ºä¾‹æ•°æ®...")
              hourly_data = []
              base_temp = 15
              
              for i in range(24):
                  hour = f"{i:02d}:00"
                  # æ¨¡æ‹Ÿæ¸©åº¦å˜åŒ–
                  if 6 <= i <= 18:  # ç™½å¤©
                      temp = base_temp + (i % 6)
                  else:  # æ™šä¸Š
                      temp = base_temp - (i % 4)
                  
                  hourly_data.append({
                      'forecast_time': hour,
                      'temperature': f"{temp}Â°C"
                  })
              
              return hourly_data
          
          # ä¸»ç¨‹åº
          beijing_time = get_beijing_time()
          update_time = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
          
          print("=" * 60)
          print("å¤©æ°”æ•°æ®æŠ“å–å¼€å§‹")
          print(f"å½“å‰æ—¶é—´: {update_time}")
          print("=" * 60)
          
          # å°è¯•æŠ“å–æ•°æ®
          hourly_data = fetch_weather_data()
          
          if not hourly_data:
              print("âš ï¸  æŠ“å–å¤±è´¥ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®")
              hourly_data = create_sample_data()
          
          # ä¿å­˜åˆ°CSV
          with open('weather_forecast.csv', 'w', newline='', encoding='utf-8') as f:
              writer = csv.writer(f)
              writer.writerow(['update_time', 'forecast_time', 'temperature', 'data_source'])
              
              for data in hourly_data:
                  writer.writerow([
                      update_time,
                      data['forecast_time'],
                      data['temperature'],
                      'https://tianqi.moji.com/weather/china/sichuan/longquanyi-district'
                  ])
          
          print(f"âœ… å·²ä¿å­˜ {len(hourly_data)} æ¡æ•°æ®åˆ° weather_forecast.csv")
          print("=" * 60)
          
          # æ˜¾ç¤ºå‰6æ¡æ•°æ®
          print("å‰6å°æ—¶é¢„æŠ¥:")
          for i in range(min(6, len(hourly_data))):
              print(f"  {hourly_data[i]['forecast_time']}: {hourly_data[i]['temperature']}")
          
          print("=" * 60)
          print("ä»»åŠ¡å®Œæˆ!")
          EOF
          
          echo "å¼€å§‹æ‰§è¡ŒPythonè„šæœ¬..."
          python3 fetch_weather_simple.py

      - name: 4. æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
          ls -la *.csv *.html 2>/dev/null || echo "æœªæ‰¾åˆ°æ–‡ä»¶"
          echo ""
          echo "=== CSVæ–‡ä»¶å†…å®¹ ==="
          if [ -f "weather_forecast.csv" ]; then
            cat weather_forecast.csv
            echo ""
            echo "è®°å½•æ•°é‡: $(( $(wc -l < weather_forecast.csv) - 1 ))"
          else
            echo "weather_forecast.csv æ–‡ä»¶ä¸å­˜åœ¨"
          fi

      - name: 5. æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add weather_forecast.csv weather_page.html 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸŒ¤ï¸ æ›´æ–°å¤©æ°”æ•°æ® [${BEIJING_TIME}]"
            git push
            echo "âœ… æ•°æ®å·²æäº¤"
          fi
