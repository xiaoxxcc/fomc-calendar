name: Auto Update Weather Data
# è§¦å‘æ¡ä»¶é…ç½®
on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/weather.yml'
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-weather-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. è®¾ç½®Pythonç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: 3. æ‰§è¡Œå¤©æ°”æ•°æ®æŠ“å–è„šæœ¬
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: |
          cat > fetch_weather.py << 'EOF'
          import requests
          import json
          import csv
          import os
          from datetime import datetime, timezone, timedelta
          
          # é…ç½®APIåœ°å€
          API_KEY = os.getenv('WEATHER_API_KEY')
          API_URL = f"https://apis.map.qq.com/ws/weather/v1/?key={API_KEY}&location=30.5703266,104.271059&type=hours"
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
          }
          
          def get_beijing_time():
              """è·å–å½“å‰åŒ—äº¬æ—¶é—´ (UTC+8)"""
              utc_now = datetime.now(timezone.utc)
              beijing_tz = timezone(timedelta(hours=8))
              beijing_now = utc_now.astimezone(beijing_tz)
              return beijing_now
          
          def fetch_weather_data():
              """ä»è…¾è®¯åœ°å›¾APIè·å–å¤©æ°”æ•°æ®"""
              print(f"ğŸ“¡ æ­£åœ¨è®¿é—®è…¾è®¯åœ°å›¾å¤©æ°”API: {API_URL}")
              try:
                  resp = requests.get(API_URL, headers=HEADERS, timeout=30)
                  resp.raise_for_status()
                  data = resp.json()
                  
                  if data.get('status') != 0:
                      print(f"âŒ APIè¿”å›é”™è¯¯: {data.get('message', 'Unknown error')}")
                      return None
                  
                  return data
              except Exception as e:
                  print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
                  return None
          
          def parse_hourly_forecast(weather_data):
              """è§£æå°æ—¶é¢„æŠ¥æ•°æ®ï¼Œæå–ç¬¬3-28ä¸ªæ•°æ®ï¼ˆç´¢å¼•2-27ï¼‰"""
              if not weather_data:
                  print("âŒ æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®")
                  return []
              
              forecast_hours = weather_data.get('result', {}).get('forecast_hours', [])
              if not forecast_hours:
                  print("âŒ æœªæ‰¾åˆ°å°æ—¶é¢„æŠ¥æ•°æ®")
                  return []
              
              first_area = forecast_hours[0]
              infos = first_area.get('infos', [])
              update_time = first_area.get('update_time', 'æœªçŸ¥æ—¶é—´')
              
              print(f"âœ… APIè¿”å›äº† {len(infos)} å°æ—¶é¢„æŠ¥æ•°æ®ï¼Œæ›´æ–°æ—¶é—´: {update_time}")
              
              # æ˜¾ç¤ºAPIè¿”å›çš„æ‰€æœ‰æ•°æ®çš„æ—¶é—´èŒƒå›´
              if infos:
                  first_time = infos[0].get('hour', 'æœªçŸ¥')
                  last_time = infos[-1].get('hour', 'æœªçŸ¥')
                  print(f"ğŸ“… æ•°æ®æ—¶é—´èŒƒå›´: {first_time} åˆ° {last_time}")
              
              # æå–ç¬¬3-28ä¸ªæ•°æ®ï¼ˆç´¢å¼•2-27ï¼‰
              start_idx = 2  # ç¬¬3ä¸ªæ•°æ®ï¼ˆç´¢å¼•2ï¼‰
              end_idx = 28   # ç¬¬28ä¸ªæ•°æ®ï¼ˆç´¢å¼•27ï¼‰
              
              hourly_data = []
              
              # æ£€æŸ¥æ•°æ®é•¿åº¦æ˜¯å¦è¶³å¤Ÿ
              if len(infos) < end_idx:
                  print(f"âš ï¸  APIåªè¿”å›äº†{len(infos)}æ¡æ•°æ®ï¼Œæ— æ³•æå–åˆ°ç¬¬{end_idx}æ¡")
                  print(f"ğŸ“Š å°†æå–ç¬¬{start_idx+1}æ¡åˆ°ç¬¬{len(infos)}æ¡æ•°æ®")
                  end_idx = len(infos)
              
              for i in range(start_idx, end_idx):
                  info_item = infos[i]
                  hour_str = info_item.get('hour', '')
                  temperature = info_item.get('info', {}).get('temperature', 'N/A')
                  
                  # æå–æ—¶é—´éƒ¨åˆ†ï¼ˆä»"2026-02-02 12:00:00"ä¸­æå–"12:00"ï¼‰
                  if hour_str and len(hour_str) >= 16:
                      # æå–"HH:MM"éƒ¨åˆ†
                      time_part = hour_str[11:16]  # å–"12:00"
                  else:
                      time_part = f"{(i+14) % 24:02d}:00"  # è°ƒæ•´é»˜è®¤æ ¼å¼
                  
                  hourly_data.append({
                      'time': time_part,
                      'temperature': temperature
                  })
              
              print(f"ğŸ“Š æˆåŠŸæå–äº†ç´¢å¼• {start_idx} åˆ° {end_idx-1} çš„æ•°æ®ï¼Œå…± {len(hourly_data)} æ¡")
              
              # æ˜¾ç¤ºæå–çš„æ•°æ®
              if hourly_data:
                  print("ğŸ“‹ æå–çš„æ•°æ®è¯¦æƒ…:")
                  for idx, data in enumerate(hourly_data):
                      original_idx = start_idx + idx
                      original_hour = infos[original_idx].get('hour', 'æœªçŸ¥æ—¶é—´') if original_idx < len(infos) else 'æœªçŸ¥'
                      print(f"  ç´¢å¼•{original_idx:2d} ({original_hour[5:16] if len(original_hour)>=16 else original_hour}): {data['time']} - {data['temperature']}â„ƒ")
              
              return hourly_data
          
          def save_to_csv(hourly_data, beijing_time):
              """å°†æ•°æ®ä¿å­˜ä¸ºCSVæ–‡ä»¶ï¼Œè¦†ç›–å†™å…¥"""
              filename = 'weather_forecast.csv'
              
              if not hourly_data:
                  print("âš ï¸  æœªè·å–åˆ°æ•°æ®ï¼Œå°†åˆ›å»ºç©ºæ–‡ä»¶")
                  with open(filename, 'w', encoding='utf-8', newline='') as f:
                      writer = csv.writer(f)
                      writer.writerow(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´'])
                  print(f"ğŸ“„ å·²åˆ›å»ºç©ºæ–‡ä»¶: {filename}")
                  return False
              
              with open(filename, 'w', encoding='utf-8', newline='') as f:
                  writer = csv.writer(f)
                  writer.writerow(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´'])
                  
                  capture_time = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
                  for data in hourly_data:
                      writer.writerow([
                          data['time'],
                          data['temperature'],
                          capture_time
                      ])
              
              print(f"ğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°: {filename}")
              print(f"ğŸ“Š å…±å†™å…¥ {len(hourly_data)} æ¡å°æ—¶é¢„æŠ¥æ•°æ®")
              
              print("ğŸ“‹ æ–‡ä»¶å†…å®¹é¢„è§ˆ:")
              print("  " + ", ".join(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´']))
              with open(filename, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
                  for i, line in enumerate(lines[:11]):
                      if i == 0:
                          continue
                      print(f"  {line.strip()}")
                  if len(lines) > 11:
                      print(f"  ... è¿˜æœ‰ {len(lines)-11} è¡Œæ•°æ®")
              
              return True
          
          def main():
              """ä¸»å‡½æ•°"""
              print("=" * 60)
              print("ğŸŒ¤ï¸  è…¾è®¯åœ°å›¾å¤©æ°”æ•°æ®è‡ªåŠ¨æŠ“å–ä»»åŠ¡å¼€å§‹")
              beijing_time = get_beijing_time()
              print(f"ğŸ“… å½“å‰åŒ—äº¬æ—¶é—´: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
              print("ğŸ“‹ å°è¯•æå–ç¬¬3-28ä¸ªæ•°æ®ï¼ˆç´¢å¼•2-27ï¼Œå…±26æ¡ï¼‰")
              print("=" * 60)
              
              weather_data = fetch_weather_data()
              if not weather_data:
                  print("âŒ è·å–å¤©æ°”æ•°æ®å¤±è´¥ï¼Œé€€å‡ºä»»åŠ¡")
                  return
              
              hourly_data = parse_hourly_forecast(weather_data)
              
              success = save_to_csv(hourly_data, beijing_time)
              
              print("=" * 60)
              if success:
                  print("âœ… ä»»åŠ¡å®Œæˆï¼")
              else:
                  print("âš ï¸  ä»»åŠ¡å®Œæˆï¼Œä½†æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®")
              print("=" * 60)
          
          if __name__ == "__main__":
              main()
          EOF
          
          echo "å¼€å§‹æ‰§è¡ŒPythonè„šæœ¬..."
          python3 fetch_weather.py

      - name: 4. æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la *.csv 2>/dev/null || echo "æœªæ‰¾åˆ°CSVæ–‡ä»¶"
          echo ""
          echo "=== weather_forecast.csv å†…å®¹é¢„è§ˆ ==="
          if [ -f "weather_forecast.csv" ]; then
            echo "æ–‡ä»¶å¤§å°: $(wc -l < weather_forecast.csv) è¡Œ"
            echo "----------------------------------------"
            head -15 weather_forecast.csv | column -t -s, 2>/dev/null || head -15 weather_forecast.csv
            echo "----------------------------------------"
          else
            echo "weather_forecast.csv æ–‡ä»¶ä¸å­˜åœ¨"
          fi

      - name: 5. æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add weather_forecast.csv 2>/dev/null || echo "æ³¨æ„ï¼šæœªæ‰¾åˆ°CSVæ–‡ä»¶"
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸŒ¤ï¸ è‡ªåŠ¨æ›´æ–°å¤©æ°”é¢„æŠ¥æ•°æ® [${BEIJING_TIME} åŒ—äº¬æ—¶é—´]"
            git push
            echo "âœ… å¤©æ°”æ•°æ®æ›´æ–°å·²æäº¤å¹¶æ¨é€ï¼"
          fi
