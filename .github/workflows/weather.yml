name: Auto Update Weather Data
on:
  schedule:
    # æ¯å°æ—¶ç¬¬1åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´æ¯å°æ—¶ç¬¬1åˆ†é’Ÿï¼‰
    - cron: '1 * * * *'
  workflow_dispatch: # å…è®¸åœ¨GitHubé¡µé¢ä¸Šæ‰‹åŠ¨è§¦å‘è¿è¡Œ
  push:
    branches: [ main ] # å½“mainåˆ†æ”¯æœ‰æ¨é€æ—¶ä¹Ÿè¿è¡Œï¼ˆå¯é€‰ï¼‰

permissions:
  contents: write # å…è®¸å·¥ä½œæµå‘ä»“åº“æäº¤æ–‡ä»¶

jobs:
  update-weather-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. è®¾ç½®Pythonç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: 3. æ‰§è¡Œå¤©æ°”æ•°æ®æŠ“å–è„šæœ¬
        run: |
          cat > fetch_weather.py << 'EOF'
          import requests
          import json
          import csv
          from datetime import datetime, timezone, timedelta
          import os
          
          # é…ç½®APIåœ°å€
          API_URL = "https://api.shwgij.com/api/tianqi/tianqi?key=CJ1owkCTEsqeI20HPZ3vxEHF3H&m=2&province=å››å·&city=æˆéƒ½&county=é¾™æ³‰é©¿åŒº"
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
          }
          
          def get_beijing_time():
              """è·å–å½“å‰åŒ—äº¬æ—¶é—´ (UTC+8)"""
              utc_now = datetime.now(timezone.utc)
              beijing_tz = timezone(timedelta(hours=8))
              beijing_now = utc_now.astimezone(beijing_tz)
              return beijing_now
          
          def fetch_weather_data():
              """ä»APIè·å–å¤©æ°”æ•°æ®"""
              print(f"ğŸ“¡ æ­£åœ¨è®¿é—®å¤©æ°”API: {API_URL}")
              try:
                  resp = requests.get(API_URL, headers=HEADERS, timeout=30)
                  resp.raise_for_status()
                  return resp.json()
              except Exception as e:
                  print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
                  return None
          
          def parse_hourly_forecast(weather_data):
              """è§£æ24å°æ—¶é¢„æŠ¥æ•°æ®ï¼Œæå–1-8å°æ—¶çš„æ¸©åº¦å’Œå¯¹åº”æ—¶é—´"""
              if not weather_data or 'data' not in weather_data:
                  print("âŒ æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®")
                  return []
              
              # è·å–forecast_1hæ•°æ®
              forecast_1h = weather_data['data'].get('forecast_1h', {})
              if not forecast_1h:
                  print("âŒ æœªæ‰¾åˆ°24å°æ—¶é¢„æŠ¥æ•°æ®")
                  return []
              
              print(f"âœ… æ‰¾åˆ° {len(forecast_1h)} å°æ—¶é¢„æŠ¥æ•°æ®")
              
              # æå–1-8å°æ—¶çš„æ•°æ®ï¼ˆå¯¹åº”ç´¢å¼•1-8ï¼‰
              hourly_data = []
              for i in range(1, 9):  # è·å–ç¬¬1åˆ°ç¬¬8å°æ—¶
                  hour_key = str(i)
                  if hour_key in forecast_1h:
                      hour_data = forecast_1h[hour_key]
                      
                      # æå–æ—¶é—´ï¼ˆä»update_timeä¸­æå–HH:MMï¼‰
                      update_time = hour_data.get('update_time', '')
                      if update_time and len(update_time) >= 10:
                          # update_timeæ ¼å¼: YYYYMMDDHHMMSS
                          hour_str = update_time[8:10] + ":00"
                      else:
                          hour_str = f"{i:02d}:00"  # å¦‚æœæ— æ³•è§£æï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
                      
                      # æå–æ¸©åº¦
                      temperature = hour_data.get('degree', 'N/A')
                      
                      hourly_data.append({
                          'time': hour_str,
                          'temperature': temperature
                      })
                  else:
                      print(f"âš ï¸  æœªæ‰¾åˆ°ç¬¬ {i} å°æ—¶çš„æ•°æ®")
              
              return hourly_data
          
          def save_to_csv(hourly_data, beijing_time):
              """å°†æ•°æ®ä¿å­˜ä¸ºCSVæ–‡ä»¶ï¼Œè¦†ç›–å†™å…¥"""
              filename = 'weather_forecast.csv'
              
              if not hourly_data:
                  print("âš ï¸  æœªè·å–åˆ°æ•°æ®ï¼Œå°†åˆ›å»ºç©ºæ–‡ä»¶")
                  # åˆ›å»ºç©ºCSVæ–‡ä»¶
                  with open(filename, 'w', encoding='utf-8', newline='') as f:
                      writer = csv.writer(f)
                      writer.writerow(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´'])
                  print(f"ğŸ“„ å·²åˆ›å»ºç©ºæ–‡ä»¶: {filename}")
                  return False
              
              # è¦†ç›–å†™å…¥CSVæ–‡ä»¶
              with open(filename, 'w', encoding='utf-8', newline='') as f:
                  writer = csv.writer(f)
                  writer.writerow(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´'])
                  
                  # å†™å…¥æ•°æ®è¡Œ
                  capture_time = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
                  for data in hourly_data:
                      writer.writerow([
                          data['time'],
                          data['temperature'],
                          capture_time
                      ])
              
              print(f"ğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°: {filename}")
              print(f"ğŸ“Š å…±å†™å…¥ {len(hourly_data)} æ¡å°æ—¶é¢„æŠ¥æ•°æ®")
              
              # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹é¢„è§ˆ
              print("ğŸ“‹ æ–‡ä»¶å†…å®¹é¢„è§ˆ:")
              print("  " + ", ".join(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´']))
              with open(filename, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
                  for i, line in enumerate(lines[:6]):  # æ˜¾ç¤ºå‰6è¡Œï¼ˆåŒ…æ‹¬è¡¨å¤´ï¼‰
                      if i == 0:
                          continue  # è·³è¿‡è¡¨å¤´è¡Œï¼Œä¸Šé¢å·²æ˜¾ç¤º
                      print(f"  {line.strip()}")
                  if len(lines) > 6:
                      print(f"  ... è¿˜æœ‰ {len(lines)-6} è¡Œæ•°æ®")
              
              return True
          
          def main():
              """ä¸»å‡½æ•°"""
              print("=" * 60)
              print("ğŸŒ¤ï¸  å¤©æ°”æ•°æ®è‡ªåŠ¨æŠ“å–ä»»åŠ¡å¼€å§‹")
              beijing_time = get_beijing_time()
              print(f"ğŸ“… å½“å‰åŒ—äº¬æ—¶é—´: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
              print("=" * 60)
              
              # è·å–å¤©æ°”æ•°æ®
              weather_data = fetch_weather_data()
              if not weather_data:
                  print("âŒ è·å–å¤©æ°”æ•°æ®å¤±è´¥ï¼Œé€€å‡ºä»»åŠ¡")
                  return
              
              # è§£æå°æ—¶é¢„æŠ¥æ•°æ®
              hourly_data = parse_hourly_forecast(weather_data)
              
              if hourly_data:
                  print("ğŸ“‹ è§£æåˆ°çš„å°æ—¶é¢„æŠ¥æ•°æ®:")
                  for i, data in enumerate(hourly_data, 1):
                      print(f"  {i:2d}. {data['time']}: {data['temperature']}â„ƒ")
              
              # ä¿å­˜ä¸ºCSVï¼ˆè¦†ç›–å†™å…¥ï¼‰
              success = save_to_csv(hourly_data, beijing_time)
              
              print("=" * 60)
              if success:
                  print("âœ… ä»»åŠ¡å®Œæˆï¼")
              else:
                  print("âš ï¸  ä»»åŠ¡å®Œæˆï¼Œä½†æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®")
              print("=" * 60)
          
          if __name__ == "__main__":
              main()
          EOF
          
          echo "å¼€å§‹æ‰§è¡ŒPythonè„šæœ¬..."
          python3 fetch_weather.py

      - name: 4. æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la *.csv 2>/dev/null || echo "æœªæ‰¾åˆ°CSVæ–‡ä»¶"
          echo ""
          echo "=== weather_forecast.csv å†…å®¹é¢„è§ˆ ==="
          if [ -f "weather_forecast.csv" ]; then
            echo "æ–‡ä»¶å¤§å°: $(wc -l < weather_forecast.csv) è¡Œ"
            echo "----------------------------------------"
            head -10 weather_forecast.csv | column -t -s, 2>/dev/null || head -10 weather_forecast.csv
            echo "----------------------------------------"
          else
            echo "weather_forecast.csv æ–‡ä»¶ä¸å­˜åœ¨"
          fi

      - name: 5. æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ ç”Ÿæˆçš„CSVæ–‡ä»¶
          git add weather_forecast.csv 2>/dev/null || echo "æ³¨æ„ï¼šæœªæ‰¾åˆ°CSVæ–‡ä»¶"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            # æäº¤å¹¶æ¨é€ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´æ—¶é—´æˆ³ï¼‰
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸŒ¤ï¸ è‡ªåŠ¨æ›´æ–°å¤©æ°”é¢„æŠ¥æ•°æ® [${BEIJING_TIME} åŒ—äº¬æ—¶é—´]"
            git push
            echo "âœ… å¤©æ°”æ•°æ®æ›´æ–°å·²æäº¤å¹¶æ¨é€ï¼"
          fi
