name: Auto Update Weather Data
on:
  # æ ¸å¿ƒä¿®å¤1ï¼šåˆå¹¶ä¸ºå”¯ä¸€çš„pushè§¦å‘è§„åˆ™ï¼Œåˆ é™¤å¤šä½™çš„pushèŠ‚ç‚¹
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/weather.yml' # ä»…ä¿®æ”¹è‡ªèº«æ–‡ä»¶æ—¶è§¦å‘ï¼Œå½»åº•éš”ç¦»FOMCå·¥ä½œæµ
  schedule:
    # ä½ çš„å®šæ—¶è§„åˆ™ï¼šUTCæ¯å°æ—¶6åˆ† â†’ åŒ—äº¬æ—¶é—´æ¯å°æ—¶6åˆ†ï¼ˆä¿ç•™ä¸å˜ï¼‰
    - cron: '6 * * * *'
  workflow_dispatch: # ä¿ç•™æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # å…è®¸æäº¤æ–‡ä»¶

jobs:
  update-weather-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ ¸å¿ƒä¿®å¤2ï¼šæ‹‰å–å®Œæ•´Gitå†å²ï¼Œè§£å†³æ¨é€å†²çª
          ref: main       # æ˜ç¡®æ‹‰å–mainåˆ†æ”¯ï¼Œé¿å…åˆ†æ”¯é”™ä¹±

      - name: 2. è®¾ç½®Pythonç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        run: |
          # æ ¸å¿ƒä¿®å¤3ï¼šç»Ÿä¸€ç”¨python3/pip3ï¼Œé€‚é…Ubuntuçš„Python2/3åˆ†ç¦»ç¯å¢ƒ
          python3 -m pip install --upgrade pip
          pip3 install requests

      - name: 3. æ‰§è¡Œå¤©æ°”æ•°æ®æŠ“å–è„šæœ¬
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: |
          cat > fetch_weather.py << 'EOF'
          import requests
          import json
          import csv
          import os
          from datetime import datetime, timezone, timedelta
          
          API_KEY = os.getenv('WEATHER_API_KEY')
          API_URL = f"https://apis.map.qq.com/ws/weather/v1/?key={API_KEY}&location=30.5703266,104.271059&type=hours"
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
          }
          
          def get_beijing_time():
              utc_now = datetime.now(timezone.utc)
              beijing_tz = timezone(timedelta(hours=8))
              beijing_now = utc_now.astimezone(beijing_tz)
              return beijing_now
          
          def fetch_weather_data():
              print(f"ğŸ“¡ æ­£åœ¨è®¿é—®è…¾è®¯åœ°å›¾å¤©æ°”API: {API_URL}")
              try:
                  resp = requests.get(API_URL, headers=HEADERS, timeout=30)
                  resp.raise_for_status()
                  data = resp.json()
                  if data.get('status') != 0:
                      print(f"âŒ APIè¿”å›é”™è¯¯: {data.get('message', 'Unknown error')}")
                      return None
                  return data
              except Exception as e:
                  print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
                  return None
          
          def parse_hourly_forecast(weather_data):
              if not weather_data:
                  print("âŒ æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®")
                  return []
              forecast_hours = weather_data.get('result', {}).get('forecast_hours', [])
              if not forecast_hours:
                  print("âŒ æœªæ‰¾åˆ°å°æ—¶é¢„æŠ¥æ•°æ®")
                  return []
              first_area = forecast_hours[0]
              infos = first_area.get('infos', [])
              update_time = first_area.get('update_time', 'æœªçŸ¥æ—¶é—´')
              print(f"âœ… æ‰¾åˆ° {len(infos)} å°æ—¶é¢„æŠ¥æ•°æ®ï¼Œæ›´æ–°æ—¶é—´: {update_time}")
              hourly_data = []
              for i in range(2, 10):
                  if i < len(infos):
                      info_item = infos[i]
                      hour_str = info_item.get('hour', '')
                      temperature = info_item.get('info', {}).get('temperature', 'N/A')
                      if hour_str and len(hour_str) >= 16:
                          time_part = hour_str[11:16]
                      else:
                          time_part = f"{(i+14) % 24:02d}:00"
                      hourly_data.append({'time': time_part, 'temperature': temperature})
                  else:
                      print(f"âš ï¸  æœªæ‰¾åˆ°ç´¢å¼• {i} çš„æ•°æ®ï¼Œinfosé•¿åº¦ä¸è¶³")
              return hourly_data
          
          def save_to_csv(hourly_data, beijing_time):
              filename = 'weather_forecast.csv'
              if not hourly_data:
                  print("âš ï¸  æœªè·å–åˆ°æ•°æ®ï¼Œå°†åˆ›å»ºç©ºæ–‡ä»¶")
                  with open(filename, 'w', encoding='utf-8', newline='') as f:
                      writer = csv.writer(f)
                      writer.writerow(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´'])
                  print(f"ğŸ“„ å·²åˆ›å»ºç©ºæ–‡ä»¶: {filename}")
                  return False
              with open(filename, 'w', encoding='utf-8', newline='') as f:
                  writer = csv.writer(f)
                  writer.writerow(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´'])
                  capture_time = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
                  for data in hourly_data:
                      writer.writerow([data['time'], data['temperature'], capture_time])
              print(f"ğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°: {filename}")
              print(f"ğŸ“Š å…±å†™å…¥ {len(hourly_data)} æ¡å°æ—¶é¢„æŠ¥æ•°æ®")
              print("ğŸ“‹ æ–‡ä»¶å†…å®¹é¢„è§ˆ:")
              print("  " + ", ".join(['æ—¶é—´', 'æ¸©åº¦(â„ƒ)', 'æŠ“å–æ—¶é—´']))
              with open(filename, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
                  for i, line in enumerate(lines[:6]):
                      if i == 0:
                          continue
                      print(f"  {line.strip()}")
                  if len(lines) > 6:
                      print(f"  ... è¿˜æœ‰ {len(lines)-6} è¡Œæ•°æ®")
              return True
          
          def main():
              print("=" * 60)
              print("ğŸŒ¤ï¸  è…¾è®¯åœ°å›¾å¤©æ°”æ•°æ®è‡ªåŠ¨æŠ“å–ä»»åŠ¡å¼€å§‹")
              beijing_time = get_beijing_time()
              print(f"ğŸ“… å½“å‰åŒ—äº¬æ—¶é—´: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
              print("ğŸ“‹ æå–ç¬¬3-10ä¸ªæ•°æ®ï¼ˆç´¢å¼•2-9ï¼‰")
              print("=" * 60)
              weather_data = fetch_weather_data()
              if not weather_data:
                  print("âŒ è·å–å¤©æ°”æ•°æ®å¤±è´¥ï¼Œé€€å‡ºä»»åŠ¡")
                  return
              hourly_data = parse_hourly_forecast(weather_data)
              if hourly_data:
                  print("ğŸ“‹ è§£æåˆ°çš„æ•°æ®ï¼ˆç´¢å¼•2-9ï¼‰:")
                  for i, data in enumerate(hourly_data, 1):
                      print(f"  ç¬¬{i:2d}æ¡: {data['time']}: {data['temperature']}â„ƒ")
              success = save_to_csv(hourly_data, beijing_time)
              print("=" * 60)
              if success:
                  print("âœ… ä»»åŠ¡å®Œæˆï¼")
              else:
                  print("âš ï¸  ä»»åŠ¡å®Œæˆï¼Œä½†æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®")
              print("=" * 60)
          
          if __name__ == "__main__":
              main()
          EOF
          
          echo "å¼€å§‹æ‰§è¡ŒPythonè„šæœ¬..."
          python3 fetch_weather.py

      - name: 4. æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la *.csv 2>/dev/null || echo "æœªæ‰¾åˆ°CSVæ–‡ä»¶"
          echo ""
          echo "=== weather_forecast.csv å†…å®¹é¢„è§ˆ ==="
          if [ -f "weather_forecast.csv" ]; then
            echo "æ–‡ä»¶å¤§å°: $(wc -l < weather_forecast.csv) è¡Œ"
            echo "----------------------------------------"
            head -10 weather_forecast.csv | column -t -s, 2>/dev/null || head -10 weather_forecast.csv
            echo "----------------------------------------"
          else
            echo "weather_forecast.csv æ–‡ä»¶ä¸å­˜åœ¨"
          fi

      - name: 5. æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å…ˆæš‚å­˜æ–‡ä»¶ï¼Œå†æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼ˆåŒé‡ä¿éšœï¼Œå½»åº•é¿å…æ¨é€å†²çªï¼‰
          git add weather_forecast.csv 2>/dev/null || echo "æ³¨æ„ï¼šæœªæ‰¾åˆ°CSVæ–‡ä»¶"
          git pull origin main --rebase
          
          # å†æ¬¡ç¡®è®¤æš‚å­˜ï¼ˆé¿å…æ‹‰å–è¿‡ç¨‹ä¸­æ–‡ä»¶çŠ¶æ€è¢«è¦†ç›–ï¼‰
          git add weather_forecast.csv 2>/dev/null || echo "æ³¨æ„ï¼šæœªæ‰¾åˆ°CSVæ–‡ä»¶"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            # æäº¤å¹¶æ¨é€ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´æ—¶é—´æˆ³ï¼‰
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸŒ¤ï¸ è‡ªåŠ¨æ›´æ–°å¤©æ°”é¢„æŠ¥æ•°æ® [${BEIJING_TIME} åŒ—äº¬æ—¶é—´]"
            git push
            echo "âœ… å¤©æ°”æ•°æ®æ›´æ–°å·²æäº¤å¹¶æ¨é€ï¼"
          fi
